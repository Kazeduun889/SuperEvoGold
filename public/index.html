<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evolution Gold</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
        let isAdmin = false;
        let activeChatUserId = userId; 

        // ТВОЯ ССЫЛКА MONETAG
        const MONETAG_LINK = 'ТВОЯ_ССЫЛКА_MONETAG';

        async function init() {
            try {
                const res = await fetch(`/api/user/${userId}`);
                const data = await res.json();
                
                document.getElementById('balance').innerText = (data.balance || 0).toFixed(1);
                document.getElementById('min-val').innerText = (data.minWithdraw || 1000) + ' G';
                
                if (data.isAdmin) {
                    isAdmin = true;
                    document.getElementById('admin-icon').style.display = 'block';
                }
                loadMessages();
            } catch (e) {}
        }

        function showScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(`screen-${name}`).classList.add('active');
            if(name !== 'admin') document.getElementById(`nav-${name}`).classList.add('active');
            
            if(name === 'admin') loadAdminData();
            if(name === 'support') {
                activeChatUserId = userId;
                document.getElementById('support-title').innerText = 'Поддержка';
                loadMessages();
            }
            tg.HapticFeedback.impactOccurred('light');
        }

        // Реклама
        function runAds() {
            window.open(MONETAG_LINK, '_blank');
            const btn = document.getElementById('adBtn');
            const t = document.getElementById('timer');
            const secSpan = document.getElementById('sec');
            
            btn.disabled = true; 
            t.style.display = 'block';
            let s = 15;
            
            const iv = setInterval(async () => {
                s--; 
                secSpan.innerText = s;
                if(s <= 0) {
                    clearInterval(iv);
                    try {
                        const res = await fetch('/api/reward', { 
                            method: 'POST', 
                            headers: {'Content-Type': 'application/json'}, 
                            body: JSON.stringify({userId}) 
                        });
                        const d = await res.json();
                        if (d.success) {
                            document.getElementById('balance').innerText = d.newBalance.toFixed(1);
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                    } catch (e) {
                        tg.showAlert('Ошибка начисления');
                    }
                    btn.disabled = false; 
                    t.style.display = 'none';
                }
            }, 1000);
        }

        // Поддержка
        async function loadMessages() {
            try {
                const res = await fetch(`/api/support/messages/${activeChatUserId}`);
                const msgs = await res.json();
                const box = document.getElementById('chat-box');
                box.innerHTML = msgs.map(m => `
                    <div class="msg ${m.sender_id == userId ? 'me' : 'support'}">${m.message}</div>
                `).join('');
                box.scrollTop = box.scrollHeight;
            } catch(e) {}
        }

        async function sendSupportMsg() {
            const input = document.getElementById('support-msg');
            const text = input.value.trim();
            if(!text) return;
            
            try {
                await fetch('/api/support/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: userId, text: text, isAdminReply: (isAdmin && activeChatUserId !== userId), targetUserId: activeChatUserId })
                });
                input.value = '';
                loadMessages();
            } catch(e) { tg.showAlert('Ошибка отправки'); }
        }

        // Админка
        async function loadAdminData() {
            try {
                const res = await fetch('/api/admin/stats');
                const s = await res.json();
                document.getElementById('admin-stats').innerText = `Юзеров: ${s.users} | Долг: ${s.debt} G`;
                
                const tRes = await fetch('/api/admin/support-list');
                const tickets = await tRes.json();
                document.getElementById('admin-tickets').innerHTML = tickets.map(t => `
                    <button class="btn" style="background: var(--card); color: #fff; font-size: 14px; padding: 12px; border: 1px solid var(--border);" onclick="openAdminChat(Number('${t.user_id}'))"></button>
                        Чат с ID: ${t.user_id}
                    </button>
                `).join('');
            } catch(e){}
        }

        function openAdminChat(targetId) {
            activeChatUserId = targetId;
            showScreen('support');
            document.getElementById('support-title').innerText = 'Ответ игроку ' + targetId;
        }

        // --- УМНОЕ СЖАТИЕ КАРТИНКИ ПЕРЕД ОТПРАВКОЙ ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; // Уменьшаем до 800px ширины
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height = Math.round((height * MAX_WIDTH) / width);
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Сжимаем в JPEG с качеством 70%
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        // Вывод с картинкой
        async function requestWithdraw() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const fileInput = document.getElementById('withdraw-image');
            
            if (!amount || amount <= 0) return tg.showAlert('Введите корректную сумму!');
            if (fileInput.files.length === 0) return tg.showAlert('Прикрепите скриншот!');

            const btn = document.getElementById('withdraw-btn');
            btn.disabled = true;
            btn.innerText = 'Сжатие и отправка...';

            try {
                // Вызываем функцию сжатия
                const imageBase64 = await compressImage(fileInput.files[0]);
                
                const res = await fetch('/api/withdraw', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ userId, amount, imageBase64 }) 
                });
                const d = await res.json();
                
                if (d.success) {
                    tg.showAlert('Заявка создана! Ожидайте выплату.');
                    document.getElementById('withdraw-amount').value = '';
                    fileInput.value = '';
                    init();
                    showScreen('main');
                } else {
                    tg.showAlert(d.message);
                }
            } catch(e) {
                tg.showAlert('Ошибка сервера. Попробуйте еще раз.');
            }
            btn.disabled = false;
            btn.innerText = 'Создать заявку';
        }

        function toggleAdminTab(tab) {
            document.getElementById('admin-tickets-section').style.display = tab === 'tickets' ? 'block' : 'none';
            document.getElementById('admin-withdrawals-section').style.display = tab === 'withdrawals' ? 'block' : 'none';
            if (tab === 'withdrawals') loadAdminWithdrawals();
        }

        async function loadAdminWithdrawals() {
            try {
                const res = await fetch('/api/admin/withdrawals');
                const list = await res.json();
                const container = document.getElementById('admin-withdrawals');
                
                if (list.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-dim); font-size: 14px;">Нет активных заявок</div>';
                    return;
                }

                container.innerHTML = list.map(w => `
                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px;">
                        <div style="margin-bottom: 10px; font-size: 14px;"><b>ID:</b> ${w.user_id} <br> <b>Сумма:</b> <span style="color: var(--primary);">${w.amount} G</span></div>
                        <img src="${w.image_base64}" style="width: 100%; border-radius: 8px; margin-bottom: 10px;">
                        <button class="btn" style="padding: 12px; font-size: 14px;" onclick="completeWithdraw(Number('${w.id}'), Number('${w.user_id}'), Number('${w.amount}'))">✅ Выплачено</button>
                    </div>
                `).join('');
            } catch(e) {}
        }

        async function completeWithdraw(id, uid, amt) {
            if(!confirm('Подтвердить выплату ' + amt + ' G?')) return;
            await fetch('/api/admin/withdrawals/complete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, userId: uid, amount: amt })
            });
            tg.showAlert('Выплата подтверждена!');
            loadAdminWithdrawals();
            loadAdminData();
        }

        // Обязательные функции инициализации (из-за которых пропали иконки)
        lucide.createIcons();
        init();
        
        setInterval(() => {
            if (document.getElementById('screen-support').classList.contains('active')) {
                loadMessages();
            }
        }, 5000);
    </script>
</body>
</html>